{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" href="{% static 'sierra/img/fav-icon.png' %}" type="image/x-icon" />
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>競爭者分析</title>

        <!-- Icon css link -->

        <link href="{% static 'sierra/css/font-awesome.min.css' %}" rel="stylesheet">
        <!-- Bootstrap -->
        <link href="{% static 'sierra/css/bootstrap.min.css' %}" rel="stylesheet">

        <!-- Rev slider css -->
        <link href="{% static 'sierravendors/revolution/css/settings.css' %}" rel="stylesheet">
        <link href="{% static 'sierra/vendors/revolution/css/layers.css' %}" rel="stylesheet">
        <link href="{% static 'sierra/vendors/revolution/css/navigation.css' %}" rel="stylesheet">

        <!-- Extra plugin css -->
        <link href="{% static 'sierra/vendors/owl-carousel/owl.carousel.min.css' %}" rel="stylesheet">
        <link href="{% static 'sierra/vendors/magnify-popup/magnific-popup.css' %}" rel="stylesheet">

        <link href="{% static 'sierra/css/style.css' %}" rel="stylesheet">
        <link href="{% static 'sierra/css/responsive.css' %}" rel="stylesheet">


        <!-- 之後加的 -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

        <!-- ADDED -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.2.2/bootstrap.min.js"></script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109921688-1"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-109921688-1');
        </script>

        <!-- 之後加的 -->


    </head>
    <body>

        <style>
            /* Table */

            .table-wrapper {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
            }

            table {
                margin: 0 0 2em 0;
                width: 100%;
            }

            table tbody tr {
                border: solid 1px;
                border-left: 0;
                border-right: 0;
            }

            table td {
                padding: 0.75em 0.75em;
            }

            table th {
                font-size: 0.9em;
                font-weight: 700;
                padding: 0 0.75em 0.75em 0.75em;
                text-align: left;
            }

            table thead {
                border-bottom: solid 2px;
            }

            table tfoot {
                border-top: solid 2px;
            }

            table.alt {
                border-collapse: separate;
            }

            table.alt tbody tr td {
                border: solid 1px;
                border-left-width: 0;
                border-top-width: 0;
            }

                table.alt tbody tr td:first-child {
                    border-left-width: 1px;
                }

                table.alt tbody tr:first-child td {
                    border-top-width: 1px;
                }

                table.alt thead {
                    border-bottom: 0;
                }

                table.alt tfoot {
                    border-top: 0;
                }

                table tbody tr {
                    border-color: rgba(0, 0, 0, 0.1);
                }

                table tbody tr:nth-child(2n + 1) {
                    background-color: rgba(0, 0, 0, 0.075);
                }

                    table th {
                        color: #000;
                        align: center;
                    }

                    table thead {
                        border-bottom-color: rgba(0, 0, 0, 0.1);
                    }

                    table tfoot {
                        border-top-color: rgba(0, 0, 0, 0.1);
                    }

                    table.alt tbody tr td {
                        border-color: rgba(0, 0, 0, 0.1);
                    }


        </style>

        <!--================Header Menu Area =================-->
        <header class="main_menu_area">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="#"><img src="{% static 'sierra/img/logo.png' %}" alt=""></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent" >
                    <ul class="navbar-nav" >
                        <li class="nav-item"><a class="nav-link" href="/home/" style="font-family: Microsoft JhengHei;">首頁</a></li>
                        <li class="nav-item"><a class="nav-link" href="/home/tendsearch/" style="font-family: Microsoft JhengHei;">標案搜尋</a></li>
                        <li class="nav-item"><a class="nav-link" href="/home/competitor/" style="font-family: Microsoft JhengHei;">競爭者分析</a></li>
                        <li class="nav-item"><a class="nav-link" href="/home/predict/" style="font-family: Microsoft JhengHei;">潛在競爭者</a></li>

                        <li class="nav-item"><a class="nav-link" href="/home/example/" style="font-family: Microsoft JhengHei;">企業分析範例</a></li>

                    </ul>
                </div>
            </nav>
        </header>
        <!--================End Header Menu Area =================-->

        <!--================頁面標題=================-->
        <section class="banner_area">
            <div class="container">
                <div class="banner_inner_text">
                    <h2>Competitor Analysis</h2>
                    <p style="font-family: Microsoft JhengHei;font-weight:bolder;">&nbsp;企業標案歷史記錄分析</p>
                </div>
            </div>
        </section>
        <!--================End 頁面標題 =================-->

         <!--================公司搜尋頁面 =================-->
         <section class="service_feature">
            <div class="container">
                    <!--==搜尋框==-->

                    <div class="search_box">
                        <ui>
                            <div class="search_bar">

                                <form method="get" action="/home/comdata/" style="font-family: Microsoft JhengHei;font-size: 18px;">
                                    <li><strong>競爭者分析-公司名稱：</strong><input type="type" name="query" placeholder="輸入公司全名">
                                    <button type="submit">搜尋</button></li>
                                </form>
                            </div>
                        </ui>


                    </div>
                    <div class="show_text" style="width: 50%;">
                            <section class="world_map_area p_100" >
                                    <div class="world_map_inner">
                                        <div class="bd-callout" style="font-family: Microsoft JhengHei;padding-bottom: 20px;">
                                            <br><br><br>

                                                <h3 style="font-family: Microsoft JhengHei;"><strong>使用方式</strong></h3>
                                                <h3 style="font-family: Microsoft JhengHei;">請在左側欄位輸入欲查詢之公司名稱 </h3>
                                                <h3 style="font-family: Microsoft JhengHei;">例如：「盈盈工程行」、「山霖企業社」等</h3>
                                                <h3 style="font-family: Microsoft JhengHei;">請留意需輸入完整公司名稱，以利查詢。</h3>

                                        </div>
                                    </div>
                                    <br>
                            </section>
                    </div>
            </div>
        </section>
        <!--================End 公司搜尋頁面 =================-->


         <!--================標案分布圖表 =================-->
         <section class="we_company_area p_100">
            <div class="container" style="width: 80%;">
                <div class="row company_inner "style="width: 100%;">

                    {% if Ydata %}
                    <div class="company_left" style="width: 50%;">

                        <div class="company_skill" style="text-align: center;">
                            <img src="{% static 'sierra/img/title-icon.png' %}" alt="" >
                            <h4 style="color: #7c8d93;font-family: Microsoft JhengHei;"><br>得標案件類別比例圖</h4>
                                <canvas id="myChart" style="padding-bottom: 0mm;"></canvas>
                        </div>
                    </div>

                    <div class="company_right" style="width: 50%;">
                        <div class="company_skill" style="text-align: center;" >

                            <img src="{% static 'sierra/img/title-icon.png' %}" alt="">

                            <h4 style="color: #7c8d93;padding-bottom: 20px;font-family: Microsoft JhengHei;"><br>每季得標收入趨勢圖</h4>
                            <canvas id="canvas"></canvas>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

        </section>
        <!--================End 標案分布圖表 =================-->

        <!--================標案分布圖表 =================-->
        <section class="we_company_area p_100">

            <div class="container" style="width: 80%;padding-top: 20px;">


                    <!--<div class="tender_history">
                        {% if Ydata %}
                        <table align="left">
                            <tr>
                                <td>
                                    <div style="position: relative;width:800px;height:0px;">
                                        <center>
                                            <canvas id="myChart"></canvas>
                                        </center>
                                    </div>
                                </td>
                                <td>
                                    <div style="position: relative;width:800px;height:0px;float:left">
                                        <canvas id="canvas"></canvas>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        <div style="width:100%;height:150px"></div>

                        <br><br><br><br><br><br><br><br><br><br><br><br><br><br>
                    </div>-->

                    <div class="tender_history">
                        <!--{% endif %}-->
                        <!--================長條圖和折線圖 =================-->
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
                        <script>
                            //得標類別統計圖
                            var options = {
                                  tooltips: {
                                    enabled: true
                                  },
                                  plugins: {
                                    datalabels: {
                                      formatter: (value, ctx) => {

                                        let sum = ctx.dataset._meta[0].total;
                                        let percentage = (value * 100 / sum).toFixed(2) + "%";
                                        return percentage;


                                      },
                                      color: '#fff',
                                    }
                                  }
                                };
                            var label = {{label|safe}}//JSON.stringify({{label|safe}});
                            var data = {{data|safe}}//JSON.stringify({{data|safe}});
                            var money = {{money|safe}}
                            var windate = {{windate|safe}}
                            //var str= {{categoryResult}};
                            console.log(typeof(label))
                            console.log(label)
                            console.log(typeof(data))
                            console.log(data)
                            var ctx = document.getElementById('myChart');
                            var ctx = document.getElementById('myChart').getContext('2d');
                            var ctx = $('#myChart');
                            var ctx = "myChart";
                            var ctx = document.getElementById('myChart');
                            var myChart = new Chart(ctx, {
                              type: 'pie',
                              data: {
                                labels: label,
                                datasets: [{
                                  label: '得標類別統計圖',
                                  data: data,
                                  backgroundColor: [
                                  'rgba(255, 99, 132, 0.6)',
                                  'rgba(54, 162, 235, 0.6)',
                                  'rgba(255, 206, 86, 0.6)',
                                  'rgba(75, 192, 192, 0.6)',
                                  'rgba(153, 102, 255, 0.6)',
                                  'rgba(255, 159, 64, 0.6)',
                                  'rgba(255, 99, 132, 0.6)',
                                  'rgba(54, 162, 235, 0.6)',
                                  'rgba(255, 206, 86, 0.6)',
                                  'rgba(75, 192, 192, 0.6)',
                                  'rgba(153, 102, 255, 0.6)'
                                  ],
                                  borderWidth: 1
                                }]
                              },
                              options: options
                            });


                            //收入折線圖
                            var lineChartData = {
                                labels: windate, //顯示區間名稱
                                datasets: [{
                                    label: '得標收入', // tootip 出現的名稱
                                    lineTension: 0, // 曲線的彎度，設0 表示直線
                                    backgroundColor: "#ea464d",
                                    borderColor: "#ea464d",
                                    borderWidth: 5,
                                    data: money, // 資料
                                    fill: false, // 是否填滿色彩
                                },
                              ]
                            };

                            function drawLineCanvas(ctx,data) {
                                window.myLine = new Chart(ctx, {  //先建立一個 chart
                                    type: 'line', // 型態
                                    data: data,
                                    options: {
                                            responsive: true,
                                            legend: { //是否要顯示圖示
                                                display: true,
                                            },
                                            tooltips: { //是否要顯示 tooltip
                                                enabled: true
                                            },
                                            scales: {  //是否要顯示 x、y 軸
                                                xAxes: [{
                                                    display: true
                                                }],
                                                yAxes: [{
                                                    display: true,
                                                    ticks: {
                                                        beginAtZero:true
                                                    }
                                                }]
                                            },
                                    },
                                });
                            };
                            window.onload = function () {
                                var ctx = document.getElementById("canvas").getContext("2d");
                                drawLineCanvas(ctx,lineChartData);
                            };

                            </script>
                    </div>
                    <div class="tender_history" style="text-align: center;font-size: 16px;padding: 20px;font-family: Microsoft JhengHei;">

                        <div style="font-size: 18px;">
                            <div>
                                <img src="{% static 'sierra/img/icon/title-icon.png' %}" alt="" style="padding-right: 20px;">
                                <strong>公司名稱：{{company_name}}&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</strong>
                                <strong>得標次數：{{win}}</strong>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</strong>
                                <strong>流標次數：{{lose}}</strong><br><br><br>
                            </div>
                        </div>
                        <hr size="10px"  align="center" width="80%">
                        {% if Ydata %}
                            <div style="width: 100%;">
                                <div class="table-wrapper">
                                    <br><br>
                                    <h3 style="border-bottom: 10px;float: left;">得標歷史紀錄</h3><br>

                                    <table class="alt" style="text-align: center;"  >

                                        <tr><th><center>決標時間</center></th><th><center>標案名稱</center></center></th><th><center>發標單位</center></th><th><center>標案類別</center></th><th><center>標案預算</center></th><th><center>得標廠商</center></th><th><center>決標金額</center></th></tr>
                                        {% for post in Ydata %}
                                            <tr>
                                            {% for i in post %}
                                                <td align='center'>{{i}}</td>
                                            {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>

                        {% else %}
                        <br><br><h3 style="text-align: center;">無得標資料</h3><br><br>
                        {% endif %}

                        {% if Ndata %}
                        <br><br>
                        <h3 style="border-bottom: 10px;float: left;">流標歷史紀錄</h3><br>

                        <table style="text-align: center;">

                            <tr><th><center>決標時間</center></th><th><center>標案名稱</center></center></th><th><center>發標單位</center></th><th><center>標案類別</center></th><th><center>標案預算</center></th><th><center>得標廠商</center></th><th><center>決標金額</center></th></tr>
                            {% for post in Ndata %}
                                <tr>
                                {% for i in post %}
                                    <td>{{i}}</td>
                                {% endfor %}
                                </tr>
                            {% endfor %}
                        </table>
                        {% else %}
                        <br><br><strong>無流標資料</strong>
                        {% endif %}
                    </div>
            </div>



        </section>
        <!--================End 標案分布圖表 =================-->


        <!--================Footer Area =================-->
        <footer class="footr_area">

            <div class="footer_copyright">
                <div class="container">
                    <div class="float-sm-left">
                        <h5><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->

<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></h5>
                    </div>

                </div>
            </div>
        </footer>
        <!--================End Footer Area =================-->




        <link href="{% static 'sierra/vendors/revolution/css/layers.css' %}" rel="stylesheet">

         <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
         <script src="{% static 'sierra/js/jquery-3.2.1.min.js' %}"></script>
         <!-- Include all compiled plugins (below), or include individual files as needed -->
         <script src="{% static 'sierra/js/popper.min.js' %}"></script>
         <script src="{% static 'sierra/js/bootstrap.min.js' %}"></script>
         <!-- Rev slider js -->
         <script src="{% static 'sierra/vendors/revolution/js/jquery.themepunch.tools.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/jquery.themepunch.revolution.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/extensions/revolution.extension.actions.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/extensions/revolution.extension.video.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/extensions/revolution.extension.slideanims.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/extensions/revolution.extension.layeranimation.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/extensions/revolution.extension.navigation.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/revolution/js/extensions/revolution.extension.slideanims.min.js' %}"></script>
         <!-- Extra plugin css -->
         <script src="{% static 'sierra/vendors/counterup/jquery.waypoints.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/counterup/jquery.counterup.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/counterup/apear.js' %}"></script>
         <script src="{% static 'sierra/vendors/counterup/countto.js' %}"></script>
         <script src="{% static 'sierra/vendors/owl-carousel/owl.carousel.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/magnify-popup/jquery.magnific-popup.min.js' %}"></script>
         <script src="{% static 'sierra/js/smoothscroll.js' %}"></script>
         <script src="{% static 'sierra/vendors/circle-bar/circle-progress.min.js' %}"></script>
         <script src="{% static 'sierra/vendors/circle-bar/plugins.js' %}"></script>

         <script src="{% static 'sierra/js/circle-active.js' %}"></script>
         <script src="{% static 'sierra/js/theme.js' %}"></script>

         <script>
            var query = document.location.search.match(/query=([^&]*)/)[1];
            query = decodeURIComponent(query);
            var page = 1;
            if (document.location.search.match(/page=([0-9]*)/)) {
                page = document.location.search.match(/page=([0-9]*)/)[1];
            }
            console.log(query)
            console.log(isNaN(query))
            if(isNaN(query)==true){ //公司名稱
              var api_url = 'https://pcc.g0v.ronny.tw/api/searchbycompanyname?query=' + encodeURIComponent(query) + '&page=' + page;

            }
            else{ //id
              var api_url = 'https://pcc.g0v.ronny.tw/api/searchbycompanyid?query=' + encodeURIComponent(query) + '&page=' + page;
            }

            $('#api_url').text(api_url);
            $.get(api_url, function(ret){
                var total = {{total_count}}
                $('#message').text('顯示搜尋「' + ret.query + '」結果，共有 ' + total + ' 筆標案資料。');
                $('#input_query').val(ret.query);
                $('.pagination ul').html('');
                for (var page = 1; page <= ret.total_pages; page ++) {
                    var a_dom = $('<a></a>').attr('href', '/home/searchbycompany/?query=' + encodeURIComponent(query) + '&page=' + page).addClass('page-link').text(page);
                    var li_dom = $('<li></li>').addClass('page-item').append(a_dom);
                    if (ret.page == page) {
                        li_dom.addClass('active');
                    }

                    $('.pagination ul').append(li_dom);
                }

                //
                // for (var i = 0; i < ret.records.length; i ++) {
                //     var record = ret.records[i];
                //     var tr_dom = $('<tr></tr>');
                //     var get_td_dom = function(){
                //         var td_dom = $('<td></td>');
                //         if (record.brief.companies.names.length > 1) {
                //             td_dom.attr('rowspan', record.brief.companies.names.length);
                //         }
                //         return td_dom;
                //     };
                //     tr_dom.append(get_td_dom().text(record.date));
                //     tr_dom.append(get_td_dom().text(record.brief.type));
                //     tr_dom.append(get_td_dom().append($('<a></a>').attr('href', '/home/unit/?unit_id=' + record.unit_id).text(record.unit_name)));
                //     var tender_url = '/home/tender/?' + [
                //         'unit_id=' + encodeURIComponent(record.unit_id),
                //         'job_number=' + encodeURIComponent(record.job_number),
                //         'date=' + encodeURIComponent(record.date),
                //         'filename=' + encodeURIComponent(record.filename)
                //         ].join('&');
                //     tr_dom.append(get_td_dom().append($('<a></a>').attr('href', tender_url).text(record.brief.title)));
                //     for (var j = 0; j < record.brief.companies.names.length; j ++) {
                //         var name = record.brief.companies.names[j];
                //         tr_dom.append($('<td></td>').text(name));
                //         var ul_dom = $('<ul></ul>');
                //         record.brief.companies.name_key[name].map(function(k) {
                //                 var li_dom = $('<li></li>').text(k);
                //                 if (k.match(/:得標廠商/)) {
                //                     li_dom.css('background-color', 'lightgreen');
                //                 } else if (k.match(/:未得標廠商/)) {
                //                     li_dom.css('background-color', 'lightpink');
                //                 }
                //                 ul_dom.append(li_dom);
                //         });
                //         tr_dom.append($('<td></td>').append(ul_dom));
                //         $('tbody').append(tr_dom);
                //         tr_dom = $('<tr></tr>');
                //     }
                // }
            }, 'json');
            </script>
    </body>
</html>
